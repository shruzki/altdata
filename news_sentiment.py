# -*- coding: utf-8 -*-
"""Untitled1.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/16CN1Xn3gyN1svKFrubxHxgnv2G_L38pV
"""

# import requests
import torch
from transformers import AutoTokenizer
import torch.nn.functional as F
from transformers import AutoModelForSequenceClassification
import pandas as pd
# import json
import numpy as np


# url = "https://mboum-finance.p.rapidapi.com/ne/news/"

# querystring = {"symbol":"AAPL"}

# headers = {
# 	"X-RapidAPI-Key": "f99a086b8bmsh015f02cd5380287p1d650djsn332441cedc2c",
# 	"X-RapidAPI-Host": "mboum-finance.p.rapidapi.com"
# }

# # response = requests.get(url, headers=headers, params=querystring)

# print(response.json())

# type(response)

response = {'item': [{'description': 'Workers at Apple stores in France began a nationwide strike over pay and working conditions on Friday in a protest designed to coincide with the launch of the iPhone 15.  It is the latest headache for the tech giant in France after it was forced to stop selling its iPhone 12 model earlier this month for above-threshold radiation.  Apple disputes the findings of the French watchdog.', 'guid': 'e0af9532-708d-3832-a602-9be73eb182ab', 'link': 'https://finance.yahoo.com/news/1-apple-workers-france-stage-121505592.html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 12:15:05 +0000', 'title': 'UPDATE 1-Apple workers in France stage strike on iPhone 15 launch day'}, {'description': "The technology is still in the early stages of its development, but Wall Street's estimates about its long-term potential are staggering.  Goldman Sachs predicts AI could add $7 trillion to global economic output over the next decade, thanks to its ability to increase productivity.  The bank has analyzed the prior productivity booms that were driven by electricity and information technology, and it says they have been preceded by massive investment cycles.", 'guid': '1823439f-bb89-3f16-86d5-c3135ad2b4bf', 'link': 'https://finance.yahoo.com/m/1823439f-bb89-3f16-86d5-c3135ad2b4bf/businesses-will-invest-%24200.html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 12:15:00 +0000', 'title': 'Businesses Will Invest $200 Billion in AI by 2025: These 2 Stocks Could Be the Biggest Winners'}, {'description': "A UK regulator on Friday said a revised proposal from Microsoft 'opens the door' to clearing the $69 billion  purchase.", 'guid': '486e3cac-afc3-4788-9bf6-570791438b82', 'link': 'https://finance.yahoo.com/news/microsoft-one-step-closer-to-uk-approval-of-activision-blizzard-deal-115942118.html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 11:59:42 +0000', 'title': 'Microsoft one step closer to UK approval of Activision Blizzard deal'}, {'description': 'In this article, we will be looking into the 30 most popular games of all time. We will also be covering recent market trends, major players and an analysis of the gaming industry. If you want to skip our detailed analysis, you can go directly to the 5 Most Popular Games of All Time. The […]', 'guid': '5c030880-d22a-34ab-a429-c5bb30e621da', 'link': 'https://finance.yahoo.com/news/30-most-popular-games-time-113509883.html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 11:33:57 +0000', 'title': '30 Most Popular Games of All Time'}, {'description': "Wall Street index futures inched up on Friday after concerns over interest rates battered stocks in the prior session, while investors awaited data and comments from policymakers to assess the Federal Reserve's next steps.  U.S. Treasury yields retreated, after surging to multi-year highs on Thursday, aiding a 0.5%-1.2% rebound in growth stocks, including Apple, Amazon.com, Nvidia and Tesla in premarket trading.  Worries over another interest rate hike in 2023 and prospects of a delay in the easing of monetary policy knocked down the three main indexes by more than 1% each on Thursday.", 'guid': 'f329126b-88d1-37af-b5bb-6edc12722cd0', 'link': 'https://finance.yahoo.com/news/us-stocks-futures-edge-wall-112519167.html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 11:25:19 +0000', 'title': 'US STOCKS-Futures edge up after Wall St rout; Fed speakers, data in focus'}, {'description': 'U.K. regulators gave preliminary approval of Microsoft’s $75 billion proposed acquisition of Activision and the United Auto Workers is threatening to expand its strike against the “Big Three” automakers if a deal isn’t reached. Here’s what investors need to know today.', 'guid': 'd3df82e4-d39c-3d7d-bc91-6025cdcfc6b9', 'link': 'https://finance.yahoo.com/m/d3df82e4-d39c-3d7d-bc91-6025cdcfc6b9/5-things-to-know-before.html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 11:18:56 +0000', 'title': '5 Things to Know Before Markets Open'}, {'description': 'A look at the stocks making headlines on Friday.', 'guid': 'c4a069ec-e090-44c2-915e-e9042fac0c06', 'link': 'https://uk.finance.yahoo.com/news/trending-tickers-microsoft--splunk--amazon--ocado-111322643.html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 11:16:14 +0000', 'title': 'Trending tickers: Microsoft | Splunk | Amazon | Ocado'}, {'description': 'The U.K. regulator said a new restructured deal substantially addresses its concerns over cloud gaming.', 'guid': 'ccb6a396-9564-39b8-bf83-592a52f80096', 'link': 'https://finance.yahoo.com/m/ccb6a396-9564-39b8-bf83-592a52f80096/microsoft%E2%80%99s-activision-deal.html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 11:16:00 +0000', 'title': 'Microsoft’s Activision Deal Provisionally Approved. What Happens Next.'}, {'description': "Apple's success isn't just about one product, it's about how many products work together.", 'guid': '5d3a51f1-9d2f-3e7b-b35f-a8012c347391', 'link': 'https://finance.yahoo.com/m/5d3a51f1-9d2f-3e7b-b35f-a8012c347391/apple%27s-superpower%3F-it%27s.html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 11:15:00 +0000', 'title': "Apple's Superpower? It's About the Ecosystem."}, {'description': "Britain's competition watchdog, the CMA, said changes to Microsoft's Activision takeover have 'opened the door' to approval.", 'guid': 'fe1f7003-ab46-3ac5-958b-d85fe60d6bd1', 'link': 'https://finance.yahoo.com/m/fe1f7003-ab46-3ac5-958b-d85fe60d6bd1/activision-gains-as-uk.html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 11:09:00 +0000', 'title': 'Activision gains as UK competition watchdog opens door to Microsoft takeover'}, {'description': 'Five things you need to know before the market opens on Friday September 22:   1. -- Stocks look to rebound from two-month lows as rate bets rattle markets  A hawkish Fed, rising oil prices and a tight job market have rekindled inflation concerns, pushing stocks to their lowest levels since June.', 'guid': '72a197cd-0952-3216-b09f-054751568b0c', 'link': 'https://finance.yahoo.com/m/72a197cd-0952-3216-b09f-054751568b0c/stocks-mixed%2C-apple-iphone.html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 11:04:00 +0000', 'title': 'Stocks mixed, Apple iPhone launch, Amazon ad plan, Activision-Microsoft deal, UAW strike deadline - 5 Things To Know'}, {'description': 'Harding Loevner, an asset management company, released its “Global Equity Strategy” second-quarter 2023 investor letter. A copy of the same can be downloaded here. In the second quarter, the strategy returned 8.02% net of fees compared to a 6.35% return for the MSCI All Country World Index and 7% for the MSCI World Index. Slowing inflation […]', 'guid': '61d830b2-a8c6-3522-aa11-290066d89a2a', 'link': 'https://finance.yahoo.com/news/microsoft-corporation-msft-gains-leadership-105241014.html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 10:52:41 +0000', 'title': 'Microsoft Corporation (MSFT) Gains a Leadership Position in Generative AI'}, {'description': "Apple's new iPhone 15 goes on general sale around the world today, but faces tough consumer headwinds heading into the holiday season.", 'guid': '0ae647b1-87b0-33be-88fa-234814d35643', 'link': 'https://finance.yahoo.com/m/0ae647b1-87b0-33be-88fa-234814d35643/apple-iphone-15-launch-day.html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 10:46:00 +0000', 'title': 'Apple iPhone 15 launch day lifts stock, but demand questions remain'}, {'description': 'Treasury yields reach levels not seen in a decade, Cisco to buy Splunk in largest acquisition to date, and other news to start your day.', 'guid': 'c16ce2ff-65e7-3cc7-a7ce-5eeb1846a29b', 'link': 'https://finance.yahoo.com/m/c16ce2ff-65e7-3cc7-a7ce-5eeb1846a29b/markets-have-been-jolted..html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 10:31:00 +0000', 'title': 'Markets Have Been Jolted. Labor Data May Prove More Vital Than Fed Talk.'}, {'description': "Not too long ago, cryptocurrencies looked like one of the best investment opportunities, as bulls thought the digital system could eventually replace traditional payment methods.  Investors seem increasingly apprehensive about cryptocurrencies, with Bitcoin's price down 4% in the last six months and Ethereum's down 10%.  Meanwhile, tech stocks have been on the rise.", 'guid': '43b64e9f-31f3-31de-aa3a-94161de2126e', 'link': 'https://finance.yahoo.com/m/43b64e9f-31f3-31de-aa3a-94161de2126e/3-artificial-intelligence.html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 10:30:00 +0000', 'title': '3 Artificial Intelligence (AI) Stocks With More Potential Than Any Cryptocurrency'}, {'description': 'Investors are left in a tough situation after an illuminating press conference where Fed Chair Jerome Powell poured cold water on optimists.', 'guid': '380c06d4-53f7-465f-965e-5bab9be87a2a', 'link': 'https://finance.yahoo.com/news/the-feds-plausible-economic-outcome-leaves-little-margin-for-investors-220022932.html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 10:00:22 +0000', 'title': "The Fed's 'plausible' economic outcome leaves little margin for investors"}, {'description': 'PARIS (Reuters) -Workers at Apple stores in France began a nationwide strike over pay and working conditions on Friday in a protest designed to coincide with the launch of the iPhone 15.  It is the latest headache for the tech giant in France after it was forced to stop selling its iPhone 12 model earlier this month for above-threshold radiation.  Apple disputes the findings of the French watchdog.', 'guid': '0c2c2f1b-705e-33b7-a1a0-eb2ceda916cd', 'link': 'https://ca.finance.yahoo.com/news/apple-workers-france-stage-strike-095217802.html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 09:52:17 +0000', 'title': 'Apple workers in France stage strike on iPhone 15 launch day'}, {'description': 'Workers at Apple stores in France began a nationwide strike over pay and working conditions on Friday in a protest designed to coincide with the launch of the iPhone 15.  It is the latest headache for the tech giant in France after it was forced to stop selling its iPhone 12 model earlier this month for above-threshold radiation.  Apple disputes the findings of the French watchdog.', 'guid': 'afe5b6ce-16b5-32ae-953f-cf87a9076df2', 'link': 'https://finance.yahoo.com/news/apple-workers-france-stage-strike-094939268.html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 09:49:39 +0000', 'title': 'Apple workers in France stage strike over work conditions on iPhone 15 launch day'}, {'description': 'Britain’s competition watchdog has signalled it is prepared to clear Microsoft’s $69bn (£56bn) takeover of Activision Blizzard.', 'guid': 'be83e7a3-9385-3c3c-ad7a-818c1f019a64', 'link': 'https://uk.finance.yahoo.com/news/uk-set-approve-microsoft-69bn-093554380.html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 09:35:54 +0000', 'title': 'UK set to approve Microsoft’s $69bn Activision Blizzard deal'}, {'description': '(Bloomberg) -- As the $69 billion deal between Microsoft Corp. and Activision Blizzard Inc. looks ever more likely to win approval in the UK, the gap between the video-game maker’s stock price and takeover offer is narrowing.Most Read from BloombergEx-Goldman Bankers Make a Fortune With Controversial Bet on CoalIndia Suspends Visas, Canada Pulls Diplomats Amid TensionsChina’s Ultra-Rich Gen Zs Flock Home as Global Tensions RiseMcCarthy Ambushed as Republican Hardliners Change Course on Spending', 'guid': 'c54b9dee-482f-3b3a-ade8-90505faf228c', 'link': 'https://finance.yahoo.com/news/activision-nears-microsoft-offer-price-085735710.html?.tsrc=rss', 'pubDate': 'Fri, 22 Sep 2023 08:57:35 +0000', 'title': 'Activision Nears Microsoft Offer Price as UK Approval in Sight'}], 'language': 'en-US', 'lastBuildDate': 'Fri, 22 Sep 2023 12:42:55 +0000'}

def news_sentiment_function(response):

    parsed_response = response

    df = pd.DataFrame(parsed_response)


    df['description'] = df['item'].apply(lambda x: x['description'])
    df['date'] = df['item'].apply(lambda x: x['pubDate'])

    df_description = df[['description', 'date']]

    tokenizer = AutoTokenizer.from_pretrained("ipuneetrathore/bert-base-cased-finetuned-finBERT")

    from sklearn.preprocessing import MinMaxScaler

    def scale_sentiment(sentiments):
        """ Scale sentiment scores from [-1...1] to [0...1] """
        mm = MinMaxScaler()
        sent_proc = np.array(sentiments).reshape(-1, 1)
        return mm.fit_transform(sent_proc)

    def _chunks(lst, n):
        """ Yield n-sized chunks from list. """
        for i in range(0, len(lst), n):
            yield lst[i:i + n]

    batch_size = 10

    result = []

    for batch in _chunks(df_description['description'].tolist(), batch_size):
        encoded = tokenizer(batch, add_special_tokens=True, max_length=256,
                            padding='max_length',return_attention_mask=True,
                            return_tensors='pt', truncation=True)
        input_ids = torch.cat([encoded['input_ids']], dim=0).to('cuda')
        attention_mask = torch.cat([encoded['attention_mask']], dim=0).to('cuda')

        model = AutoModelForSequenceClassification.from_pretrained("ipuneetrathore/bert-base-cased-finetuned-finBERT").eval().to('cuda')
        model_output = model(input_ids, token_type_ids=None, attention_mask=attention_mask)
        logits = model_output[0]
        softmax_output = F.softmax(logits, dim=1).cpu().detach().numpy()

        sentiment_score = softmax_output[:, 2] - softmax_output[:, 0]

        mean_score = np.array(sentiment_score).ravel().mean()

        scaled_sentiment_scores = scale_sentiment(sentiment_score)

        result.append(scaled_sentiment_scores)

    merged_array = np.concatenate(result)
    df['sentiment'] = [merged_array]
